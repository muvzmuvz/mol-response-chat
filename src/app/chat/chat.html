<div class="chat-container">
  <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
  <div *ngIf="contextMenuVisible" class="context-menu" [style.top.px]="contextMenuPosition.y"
    [style.left.px]="contextMenuPosition.x">

    <!-- –ï—Å–ª–∏ —Ä–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ –∞–∫—Ç–∏–≤–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç –ø—É–Ω–∫—Ç -->
    <ng-container *ngIf="showSelectionMode; else normalMenu">
      <div class="context-menu-item" (click)="replyToSelectedMessages()">
        –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
      </div>
      <div class="context-menu-item" (click)="finishSelectMessages()">
        –û—Ç–º–µ–Ω–∞ –≤—ã–±–æ—Ä–∞
      </div>
    </ng-container>

    <ng-template #normalMenu>
      <div class="context-menu-item">
        <strong>–†–µ–∞–∫—Ü–∏—è:</strong>
      </div>
      <div class="context-menu-emoji-list">
        <span class="context-menu-emoji" *ngFor="let emoji of reactionEmojis" (click)="addReactionToMessage(emoji)">
          {{emoji}}
        </span>
      </div>

      <div class="context-menu-item" (click)="startSelectMessages()">
        –í—ã–±—Ä–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
      </div>

      <div class="context-menu-item" (click)="replyToMessage(contextMenuMessageIndex!)">
        –û—Ç–≤–µ—Ç–∏—Ç—å
      </div>
    </ng-template>
  </div>

  <h2>–ß–∞—Ç</h2>

  <div *ngIf="isNamed">
    <div class="messages" #messagesContainer
      style="max-height: 500px !important; min-height: 500px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">

      <!-- –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –æ—Ç–¥–µ–ª—å–Ω–æ–π –∫–æ–ª–æ–Ω–∫–æ–π –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ -->
      <div *ngFor="let msg of messages; let i = index" class="message-row">
        <!-- –ö–æ–ª–æ–Ω–∫–∞ —Å —á–µ–∫–±–æ–∫—Å–æ–º -->
        <div class="checkbox-column" *ngIf="showSelectionMode">
          <input type="checkbox" class="select-checkbox" id="select-msg-{{i}}" [checked]="selectedMessages.has(i)"
            (change)="toggleSelectMessage(i)" />
          <label for="select-msg-{{i}}"></label>
        </div>

        <div class="message-content" [id]="'msg-' + i" [ngClass]="{
                user: isMyMessage(msg.userId),
                other: !isMyMessage(msg.userId),
                highlighted: highlightedMessageIndex === i
              }" (contextmenu)="onRightClick($event, i)">
          <strong>{{ msg.username }}:</strong>
          <div>{{ msg.text }}</div>

          <!-- –†–µ–∞–∫—Ü–∏–∏ -->
          <div *ngIf="msg.reactions" style="margin-top: 4px; font-size: 0.85rem;">
            <span *ngFor="let key of objectKeys(msg.reactions)" style="margin-right: 8px;">
              {{key}} {{msg.reactions[key]}}
            </span>
          </div>

          <!-- –¶–∏—Ç–∞—Ç—ã (–æ—Ç–≤–µ—Ç—ã) -->
          <div *ngIf="msg.replyTo?.length">
            <div *ngFor="let rep of msg.replyTo" class="reply-quote" (click)="scrollToMessage(rep.msgIndex)"
              style="cursor:pointer; user-select:none;">
              <em>–û—Ç–≤–µ—Ç –Ω–∞ {{ rep.username }}: "{{ rep.text | slice:0:30 }}..."</em>
            </div>
          </div>

          <button *ngIf="showReplyButtonIndex === i" class="reply-button" (click)="replyToMessage(i)">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ –≤—ã–±–æ—Ä–∞ -->
    <div *ngIf="showSelectionMode" style="margin: 8px 0; display: flex; gap: 12px;">
      <button [disabled]="selectedMessages.size === 0" (click)="replyToSelectedMessages()">–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞
        –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
      <button (click)="finishSelectMessages()">–û—Ç–º–µ–Ω–∞ –≤—ã–±–æ—Ä–∞</button>
    </div>

    <!-- –¶–∏—Ç–∞—Ç—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–≤–µ—á–∞–µ–º, –Ω–∞–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ -->
    <div *ngIf="replyToList.length > 0" class="reply-to-container">
      <div *ngFor="let rep of replyToList; let i = index" class="reply-to-text-container">
        <div class="reply-to-text" (click)="scrollToMessage(rep.msgIndex)" style="cursor:pointer; user-select:none;">
          <strong>–û—Ç–≤–µ—Ç –Ω–∞ {{ rep.username }}:</strong> {{ rep.text | slice:0:50 }}...
        </div>
        <button class="cancel-reply" (click)="cancelReply(i)">√ó</button>
      </div>
    </div>

    <div class="input" style="margin-top: 10px; position: relative;">
      <input [(ngModel)]="newMessage" (keydown.enter)="sendMessage()" (input)="onInput()"
        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />

      <button type="button" class="emoji-toggle-button" (click)="toggleEmojiPicker()" title="–í—ã–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏">üòä</button>

      <button (click)="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

      <div class="emoji-picker" *ngIf="showEmojiPicker">
        <span class="emoji" *ngFor="let emoji of emojis" (click)="addEmoji(emoji)">{{emoji}}</span>
      </div>
    </div>

    <div class="typing-indicator" *ngIf="typingUsers.size > 0">
      <em>{{ array.from(typingUsers).join(', ') }} –ø–µ—á–∞—Ç–∞–µ—Ç...</em>
    </div>
  </div>
</div>